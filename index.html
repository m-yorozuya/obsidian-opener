<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Redirecting to Obsidian...</title>
</head>
<body>
    <p id="message">Obsidianを呼び出しています...</p>
    <script>
        const params = new URLSearchParams(window.location.search);
        const vault = params.get('vault');
        const file = params.get('file');
        const mode = params.get('mode');
        const template = params.get('template');
        const trelloUrl = params.get('trello_url'); // TrelloのURLを取得

        if (vault && file) {
            const encodedVault = encodeURIComponent(vault);
            const encodedFile = encodeURIComponent(file);
            let advancedUri;

            if (mode === 'new') {
                // 基本の作成URL
                advancedUri = `obsidian://advanced-uri?vault=${encodedVault}&filepath=${encodedFile}&mode=new&templater=true`;

                // テンプレートの指定があれば追加
                if (template) {
                    advancedUri += `&template=${encodeURIComponent(template)}`;
                }

                // TrelloのURLがあれば frontmatter パラメータとして追加
                if (trelloUrl) {
                    // JSON形式でプロパティを指定する
                    const fm = JSON.stringify({ "Trello": trelloUrl });
                    advancedUri += `&frontmatter=${encodeURIComponent(fm)}`;
                }
            } else {
                // オープンモード
                advancedUri = `obsidian://advanced-uri?vault=${encodedVault}&filepath=${encodedFile}`;
            }
            
            window.location.href = advancedUri;
            setTimeout(() => window.close(), 1500);
        }
    </script>
</body>
</html>