<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Redirecting to Obsidian...</title>
</head>
<body>
    <p id="message">Obsidianを呼び出しています...</p>
    <script>
        const params = new URLSearchParams(window.location.search);
        const vault = params.get('vault');
        const file = params.get('file');
        const mode = params.get('mode');
        // const template = params.get('template');
        const trelloUrl = params.get('trello_url'); // TrelloのURLを取得

        if (vault && file) {
            const encodedVault = encodeURIComponent(vault);
            const encodedFile = encodeURIComponent(file);
            let advancedUri;

            if (mode === 'new') {
                // 基本の作成URL
                advancedUri = `obsidian://advanced-uri?vault=${encodedVault}&filepath=inbox/${encodedFile}&mode=new&commandid=templater-obsidian:templater/task.md`;
            } else if (mode === 'overwrite') {
                advancedUri = `obsidian://advanced-uri?vault=${encodedVault}&filepath=inbox/${encodedFile}&mode=overwrite`
                // TrelloのURLがあれば frontmatterkey, data パラメータとして追加
                if (trelloUrl) {
                    advancedUri += `&frontmatterkey=Trello&data=${encodeURIComponent(trelloUrl)}`;
                }
            } else if (mode === 'open'){
                // オープンモード
                advancedUri = `obsidian://advanced-uri?vault=${encodedVault}&filepath=inbox/${encodedFile}`;
            }
            
            window.location.href = advancedUri;
            setTimeout(() => window.close(), 1500);
        }
    </script>
</body>
</html>